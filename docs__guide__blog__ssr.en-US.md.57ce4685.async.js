(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[20],{"6K3H":function(e,t,n){"use strict";n.r(t);var a=n("3Nsx"),o=n.n(a),r=n("C8qh"),s=n("sBO+"),i=o.a.memo((e=>{e.demos;return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"markdown"},o.a.createElement("h1",{id:"react-hooks--ssr"},o.a.createElement(r["AnchorLink"],{to:"#react-hooks--ssr","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"React Hooks & SSR"),o.a.createElement("p",null,"Server-Side Rendering refers to the page processing technology where the HTML structure of the page is spliced on the server side. Generally used to solve SEO problems and speed up the first screen."),o.a.createElement("p",null,"Since SSR executes JS code in a non-browser environment, there will be many problems. This article mainly introduces the common problems and solutions of React Hooks in SSR mode."),o.a.createElement("h2",{id:"problem-1-dombom-is-missing"},o.a.createElement(r["AnchorLink"],{to:"#problem-1-dombom-is-missing","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"Problem 1: DOM/BOM is missing"),o.a.createElement("p",null,"SSR is to run React code in a node environment, while global properties such as window, document, and navigator are not available at this time. If you use these properties directly, you will get errors like ",o.a.createElement("code",null,"window is not defined, document is not defined, navigator is not defined"),", etc."),o.a.createElement("p",null,"A common misuse is that global properties, such as document, are used directly during the execution of Hooks."),o.a.createElement(s["a"],{code:"import React, { useState } from 'react';\n\nexport default () => {\n  const [state, setState] = useState(document.visibilityState);\n  return state;\n};",lang:"js"}),o.a.createElement("h3",{id:"solution"},o.a.createElement(r["AnchorLink"],{to:"#solution","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"Solution"),o.a.createElement("ol",null,o.a.createElement("li",null,"Put the code of accessing the DOM/BOM in useEffect/useLayoutEffect (the server will not execute it) to avoid errors when the server executes, for example:")),o.a.createElement(s["a"],{code:"import React, { useState, useEffect } from 'react';\n\nexport default () => {\n  const [state, setState] = useState();\n\n  useEffect(() => {\n    setState(document.visibilityState);\n  }, []);\n\n  return state;\n};",lang:"js"}),o.a.createElement("ol",{start:2},o.a.createElement("li",null,"Differentiate the environments by ",o.a.createElement("code",null,"isBrowser"))),o.a.createElement(s["a"],{code:"import React, { useState } from 'react';\n\nfunction isBrowser() {\n  return !!(typeof window !== 'undefined' && window.document && window.document.createElement);\n}\n\nexport default () => {\n  const [state, setState] = useState(isBrowser() && document.visibilityState);\n\n  return state;\n};",lang:"js"}),o.a.createElement("h2",{id:"problem-2-uselayouteffect-warning"},o.a.createElement(r["AnchorLink"],{to:"#problem-2-uselayouteffect-warning","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"Problem 2: useLayoutEffect Warning"),o.a.createElement("p",null,"If ",o.a.createElement("code",null,"useLayoutEffect")," is used, the following warning will appear in SSR mode"),o.a.createElement("blockquote",null,o.a.createElement("p",null,"\u26a0\ufe0f Warning: useLayoutEffect does nothing on the server, because its effect cannot be encoded into the server renderer's output format. This will lead to a mismatch between the initial, non-hydrated UI and the intended UI. To avoid this, useLayoutEffect should only be used in components that render exclusively on the client. See ",o.a.createElement(r["Link"],{to:"https://fb.me/react-uselayouteffect-ssr"},"https://fb.me/react-uselayouteffect-ssr")," for common fixes.")),o.a.createElement("h3",{id:"solution-1"},o.a.createElement(r["AnchorLink"],{to:"#solution-1","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"Solution"),o.a.createElement("ol",null,o.a.createElement("li",null,"Use useEffect instead of useLayoutEffect (nonsense)"),o.a.createElement("li",null,"Dynamically specify whether to use useEffect or useLayoutEffect according to the environment. This is a hack solution from the community, currently in ",o.a.createElement(r["Link"],{to:"https://github.com/reduxjs/react-redux/blob/d16262582b2eeb62c05313fca3eb59dc0b395955/src/components/connectAdvanced.js#L40"},"react-redux"),", ",o.a.createElement(r["Link"],{to:"https://github.com/streamich/react-use/blob/master/src/useIsomorphicLayoutEffect.ts"},"react-use"),", ",o.a.createElement(r["Link"],{to:"https://github.com/atlassian/react-beautiful-dnd/blob/master/src/view/use-isomorphic-layout-effect.js"},"react-beautiful-dnd"),".")),o.a.createElement(s["a"],{code:"import { useLayoutEffect, useEffect } from 'react';\nconst useIsomorphicLayoutEffect = isBrowser() ? useLayoutEffect : useEffect;\nexport default useIsomorphicLayoutEffect;",lang:"js"}),o.a.createElement("h2",{id:"summary-need-to-pay-attention-when-writing-hooks"},o.a.createElement(r["AnchorLink"],{to:"#summary-need-to-pay-attention-when-writing-hooks","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"Summary: Need to pay attention when writing Hooks"),o.a.createElement("ol",null,o.a.createElement("li",null,"Do not use DOM/BOM properties directly in non-useEffect/useLayoutEffect"),o.a.createElement("li",null,"When using DOM/BOM properties other than useEffect/useLayoutEffect, use ",o.a.createElement("code",null,"isBrowser")," to determine whether to execute in the browser environment"),o.a.createElement("li",null,"If a Hook needs to receive DOM/BOM properties, it needs to support passing the properties via a function type parameter. Take the useEventListener of ahooks as an example, it must support the function type to specify the target option.")),o.a.createElement(s["a"],{code:"import React, { useState } from 'react';\nimport { useEventListener } from 'ahooks';\n\nexport default () => {\n  const [value, setValue] = useState(0);\n\n  const clickHandler = () => {\n    setValue(value + 1);\n  };\n\n  useEventListener(\n    'click',\n    clickHandler,\n    {\n-       target: document.getElementById('click-btn')\n+       target: () => document.getElementById('click-btn')\n    }\n  );\n\n  return (\n    <button id=\"click-btn\" type=\"button\">\n      You click {value} times\n    </button>\n  );\n};",lang:"diff"}),o.a.createElement("ol",{start:4},o.a.createElement("li",null,"Use ",o.a.createElement("code",null,"useIsomorphicLayoutEffect")," instead of ",o.a.createElement("code",null,"useLayoutEffect"))),o.a.createElement("h2",{id:"reference"},o.a.createElement(r["AnchorLink"],{to:"#reference","aria-hidden":"true",tabIndex:-1},o.a.createElement("span",{className:"icon icon-link"})),"Reference"),o.a.createElement("ul",null,o.a.createElement("li",null,o.a.createElement(r["Link"],{to:"https://github.com/alibaba/hooks/pull/935/files"},"fix: useDocumentVisiblility support ssr")),o.a.createElement("li",null,o.a.createElement(r["Link"],{to:"https://umijs.org/docs/ssr#window-is-not-defined-document-is-not-defined-navigator-is-not-defined"},"UmiJS \u670d\u52a1\u7aef\u6e32\u67d3")),o.a.createElement("li",null,o.a.createElement(r["Link"],{to:"https://medium.com/@alexandereardon/uselayouteffect-and-ssr-192986cdcf7a"},"useLayoutEffect and SSR")))))}));t["default"]=e=>{var t=o.a.useContext(r["context"]),n=t.demos;return o.a.useEffect((()=>{var t;null!==e&&void 0!==e&&null!==(t=e.location)&&void 0!==t&&t.hash&&r["AnchorLink"].scrollToAnchor(decodeURIComponent(e.location.hash.slice(1)))}),[]),o.a.createElement(i,{demos:n})}}}]);